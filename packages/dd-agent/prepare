#!/usr/bin/env bash -e

PACKAGE="dd-agent"
VERSION="5.12.1"
FILE="dd-agent-${VERSION}.tar.gz"
URL="https://github.com/DataDog/dd-agent/archive/${VERSION}.tar.gz"

if [ ! -s "${PACKAGE}/${FILE}" ]; then
  echo "  Downloading ${URL} ..."
  mkdir -p ${PACKAGE}
  curl -L -s "${URL}" -o "${PACKAGE}/${FILE}"
fi

PACKAGE="integrations-core"
FILE="integrations-core-${VERSION}.tar.gz"
URL="https://github.com/DataDog/integrations-core/archive/${VERSION}.tar.gz"

if [ ! -s "${PACKAGE}/${FILE}" ]; then
  echo "  Downloading ${URL} ..."
  mkdir -p ${PACKAGE}
  curl -L -s "${URL}" -o "${PACKAGE}/${FILE}"
fi

echo "  Populating the gohai submodule ..."
git submodule init
git submodule update

python ../packages/dd-agent/get-pip-reqs.py

echo "  Running 'go get' to get all the dependencies"
export GOPATH=$(pwd)
export GOBIN=$GOPATH
pushd ../src/gohai
  go get github.com/Masterminds/glide
  # curl https://glide.sh/get | sh
  # go get -d
  glide install
  # go build -o gohai
popd
rm glide
rm -rf src/github.com/Masterminds/glide
rm -rf pkg/darwin_amd64/github.com/Masterminds/glide
