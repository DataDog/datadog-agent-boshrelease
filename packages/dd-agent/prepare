#!/usr/bin/env bash -e

PACKAGE="dd-agent"
VERSION="5.12.1"
FILE="dd-agent-${VERSION}.tar.gz"
URL="https://github.com/DataDog/dd-agent/archive/${VERSION}.tar.gz"

if [ ! -s "${PACKAGE}/${FILE}" ]; then
  echo "  Downloading ${URL} ..."
  mkdir -p ${PACKAGE}
  curl -L -s "${URL}" -o "${PACKAGE}/${FILE}"
fi

PACKAGE="integrations-core"
FILE="integrations-core-${VERSION}.tar.gz"
URL="https://github.com/DataDog/integrations-core/archive/${VERSION}.tar.gz"

if [ ! -s "${PACKAGE}/${FILE}" ]; then
  echo "  Downloading ${URL} ..."
  mkdir -p ${PACKAGE}
  curl -L -s "${URL}" -o "${PACKAGE}/${FILE}"
fi

echo "  Populating the gohai submodule ..."
git submodule init
git submodule update

python ../packages/dd-agent/get-pip-reqs.py

# This should not be hardcoded like this, but for now we'll do this as there's not a lot of other choices.
# otherwise, it'll download a version that needs to be compiled, resulting in a failure
curl -L -s "https://pypi.python.org/packages/d4/a5/a6948a4a294818780333561096cd7196f48ce0760ef1464c251bf873892d/psycopg2-2.7.1-cp27-cp27m-manylinux1_x86_64.whl#md5=c26092b85c2710b6cd66f3cc3ef03994" -o "python-deps/psycopg2-2.7.1-cp27-cp27m-manylinux1_x86_64.whl"

curl -L -s "https://pypi.python.org/packages/48/ec/a90c9a21c15ea162015e58c8e4cd3cfff02602414eea57272441c6a74db4/boto-2.39.0-py2.py3-none-any.whl#md5=7a3905b33f003950e16e19b1f8ee8725" -o "python-deps/boto-2.39.0-py2.py3-none-any.whl"

echo "  Running 'go get' to get all the dependencies"
export GOPATH=$(pwd)
export GOBIN=$GOPATH
pushd ../src/gohai
  go get github.com/Masterminds/glide
  # curl https://glide.sh/get | sh
  # go get -d
  glide install
  # go build -o gohai
popd
rm glide
rm -rf src/github.com/Masterminds/glide
rm -rf pkg/darwin_amd64/github.com/Masterminds/glide
