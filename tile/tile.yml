name: datadog
icon_file: resources/icon.png
label: Datadog Nozzle for PCF
description: Send metrics from Cloud Foundry metrics to Datadog!

apply_open_security_group: false       # Apply open security group, default: false
allow_paid_service_plans: false        # Allow paid service plans, default: false

stemcell_criteria:
  os: ubuntu-trusty
  requires_cpi: false
  version: '3263'

properties:
- name: author
  type: string
  label: Author
  value: Greg Meyer

forms:
- name: datadog-config
  label: Datadog Config
  description: Configure your Datadog Firehose Nozzle!
  properties:
  - name: api_key
    type: secret
    label: Datadog API Key
    description: Your Datadog API Key
  - name: api_url
    type: string
    label: Datadog API URL
    description: The Datadog API endpoint to send your metrics to
    default: https://app.datadoghq.com/api/v1/series
  - name: metric_prefix
    type: string
    label: Metric Prefix
    description: The metric prefix. Setting this to anything other than the default will have billing implications.
    optional: true
  - name: tags
    type: string
    label: Tags
    description: Set custom tags, separated by a comma (e.g. foundry:thisone,env:production)
    optional: true
  - name: app_metrics
    type: boolean
    label: App Metrics
    default: true
    description: Grab app container metrics (e.g. cpu and memory usage).

- name: cf-config
  label: Cloud Foundry Settings
  description: Cloud Foundry connection details
  markdown: |
    A [UAA Client and Secret](https://docs.pivotal.io/pivotalcf/uaa/uaa-user-management.html) is required to use the datadog firehose nozzle
    Failing to specify the API user on versions without `datadog-firehose` will result in:

    ```
    unknown property "datadog_firehose_credentials"...
    ```

    See the docs for detailed instructions on creating a user.
  properties:
  - name: insecure_ssl_skip_verify
    type: boolean
    label: Skip SSL validation
    default: false
    description: Skip SSL validation (to allow things like self-signed certs). Do not set to true in production.
  - name: disable_access_control
    type: boolean
    label: Disable Access Control
    default: false
    description: Disable Access Control
  - name: uaa_client
    type: string
    label: UAA Client
    description: UAA client (a user having both "cloud_controller.admin_read_only" and "doppler.firehose")
    optional: false
  - name: uaa_secret
    type: secret
    label: UAA Secret
    description: Secret for the UAA Client
    optional: false
  - name: firehose_subscription_id
    type: string
    label: Firehose subscription id
    default: datadog-firehose-subscription-id
    description: Subscription id unique to nozzle; firehose balances across socket connections having same id.
  - name: num_workers
    type: integer
    label: Number of Worker Threads
    description: The number of worker threads to use in the nozzle
    default: 4
  - name: grab_interval
    type: integer
    label: App Metrics Interval
    description: The interval at which to grab the app metrics
    default: 10
  - name: http_proxy_url
    type: string
    optional: true
    label: HTTP Proxy URL
    description: Set a URL for an http proxy
  - name: https_proxy_url
    type: string
    optional: true
    label: HTTPS Proxy URL
    description: Set a URL for an https proxy
  - name: no_proxy
    type: string
    optional: true
    label: No Proxy
    description: Set urls that should skip the proxy, separated by a comma (e.g. datadoghq.com,google.com,example.engineering)

packages:
- name: datadog-firehose-nozzle-release
  type: bosh-release
  path: resources/datadog-firehose-nozzle-release.tgz
  jobs:
    - name: datadog-firehose-nozzle
      templates:
      - name: datadog-firehose-nozzle
        release: datadog-firehose-nozzle
      dynamic_ip: 1
      instances: 1
      properties:
        datadog:
          api_key: (( .properties.api_key.value ))
          api_url: (( .properties.api_url.value ))
          metric_prefix: (( .properties.metric_prefix.value ))
          custom_tags: (( .properties.tags.value ))
        loggregator:
          traffic_controller_url: wss://doppler.(( ..cf.cloud_controller.system_domain.value )):443
        nozzle:
          insecure_ssl_skip_verify: (( .properties.insecure_ssl_skip_verify.value ))
          disable_access_control: (( .properties.disable_access_control.value ))
          subscription_id: (( .properties.firehose_subscription_id.value ))
          deployment: (( name ))
          app_metrics: (( .properties.app_metrics.value ))
          num_workers: (( .properties.num_workers.value ))
          grab_interval: (( .properties.grab_interval.value ))
          http_proxy_url: (( .properties.http_proxy_url.value ))
          https_proxy_url: (( .properties.https_proxy_url.value ))
          no_proxy: (( .properties.no_proxy.value ))
        uaa:
          client: (( .properties.uaa_client.value ))
          client_secret: (( .properties.uaa_secret.value ))
          url: https://uaa.(( ..cf.cloud_controller.system_domain.value ))
        cc:
          endpoint: https://api.(( ..cf.cloud_controller.system_domain.value ))
