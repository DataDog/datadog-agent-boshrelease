name: datadog
icon_file: resources/icon.png
label: Datadog Cluster Monitoring for PCF
description: Send metrics from Cloud Foundry metrics to Datadog!

apply_open_security_group: false       # Apply open security group, default: false
allow_paid_service_plans: false        # Allow paid service plans, default: false

stemcell_criteria:
  os: ubuntu-xenial
  requires_cpi: false
  version: '170'

properties:
- name: author
  type: string
  label: Author
  value: Greg Meyer

forms:
- name: datadog-config
  label: Datadog Config
  description: Datadog Configuration
  markdown: This is common configuration to both the Datadog Firehose Nozzle and the Datadog Agent
  properties:
  - name: api_key
    type: secret
    label: Datadog API Key
    description: Your Datadog API Key
  - name: api_url
    type: string
    label: Datadog API URL
    description: The host of the Datadog intake server to send data to (e.g. https://app.datadoghq.com)
    default: https://app.datadoghq.com
  - name: tags
    type: string
    label: Tags
    description: Set custom tags, separated by a comma (e.g. foundry:myfoundry,env:production)
    optional: true
  - name: http_proxy_url
    type: string
    optional: true
    label: HTTP Proxy URL
    description: Set a URL for an http proxy
  - name: https_proxy_url
    type: string
    optional: true
    label: HTTPS Proxy URL
    description: Set a URL for an https proxy
  - name: no_proxy
    type: string
    optional: true
    label: No Proxy
    description: Set urls that should skip the proxy, separated by a comma (e.g. datadoghq.com,google.com,example.engineering)

- name: additional-datadog-endpoints
  label: Additional Endpoints
  description: Additional Datadog Endpoints
  markdown: This is common additional configuration to both the Datadog Firehose Nozzle and the Datadog Agent
  properties:
  - name: additional_api_url_1
    type: string
    label: Additional Datadog API URL 1
    description: The host of the Datadog intake server to send data to (e.g. https://app.datadoghq.com)
    default: https://app.datadoghq.com
  - name: additional_api_key_1
    type: secret
    optional: true
    label: Additional Datadog API Key 1
    description: Your Datadog Additional API Key 1
  - name: additional_api_url_2
    type: string
    label: Additional Datadog API URL 2
    description: The host of the Datadog intake server to send data to (e.g. https://app.datadoghq.com)
    default: https://app.datadoghq.com
  - name: additional_api_key_2
    type: secret
    optional: true
    label: Additional Datadog API Key 2
    description: Your Datadog Additional API Key 2
  - name: additional_api_url_3
    type: string
    label: Additional Datadog API URL 3
    description: The host of the Datadog intake server to send data to (e.g. https://app.datadoghq.com)
    default: https://app.datadoghq.com
  - name: additional_api_key_3
    type: secret
    optional: true
    label: Additional Datadog API Key 3
    description: Your Datadog Additional API Key 3
  - name: additional_api_url_4
    type: string
    label: Additional Datadog API URL 4
    description: The host of the Datadog intake server to send data to (e.g. https://app.datadoghq.com)
    default: https://app.datadoghq.com
  - name: additional_api_key_4
    type: secret
    optional: true
    label: Additional Datadog API Key 4
    description: Your Datadog Additional API Key 4
  - name: additional_api_url_5
    type: string
    label: Additional Datadog API URL 5
    description: The host of the Datadog intake server to send data to (e.g. https://app.datadoghq.com)
    default: https://app.datadoghq.com
  - name: additional_api_key_5
    type: secret
    optional: true
    label: Additional Datadog API Key 5
    description: Your Datadog Additional API Key 5

- name: datadog-nozzle-config
  label: Datadog Firehose Nozzle Config
  description: Configure your Datadog Firehose Nozzle
  properties:
  - name: metric_prefix
    type: string
    label: Metric Prefix
    description: The metric prefix. Setting this to anything other than the default will have billing implications.
    optional: true
  - name: app_metrics
    type: boolean
    label: App Metrics
    default: true
    description: Grab app container metrics (e.g. cpu and memory usage).
  - name: num_workers
    type: integer
    label: Number of Worker Threads
    description: The number of worker threads to use in the nozzle
    default: 4
  - name: grab_interval
    type: integer
    label: App Metrics Interval
    description: The interval at which to grab the app metrics
    default: 10
  - name: flush_duration_seconds
    type: integer
    label: Flush Duration
    description: the interval (in seconds) to flush the collected metrics to datadog
    default: 15
  - name: flush_max_bytes
    type: integer
    label: Flush Max Bytes
    description: The maximum number of bytes to send per POST request
    default: 2097152

- name: datadog-agent-config
  label: Datadog Agent Config
  description: Configure your Datadog Agent!
  properties:
  - name: skip_ssl_validation
    type: boolean
    label: Skip SSL validation
    default: false
    description: Configure the Datadog agent to skip SSL validation
  - name: use_uuid_hostname
    type: boolean
    label: Use UUID Hostname
    default: false
    description: By default we use a friendly hostname, this might cause problems with some setups. Set this to use the UUID instead. (In an environment where there are multiple hosts of the same type on different deployments or in different foundries, this will be necessary.) If dd.hostname is set, it will take precedence over the uuid hostname.
  - name: use_friendly_hostname
    type: boolean
    label: Use Friendly Hostname
    default: true
    description: By default we use a friendly hostname, this might cause problems with some setups. If you set the UUID hostname to true, it will supercede this one. If you set both to false, the agent will detect the underlying hostname and use that instead.
  - name: process_agent_enabled
    label: Enable Process Agent
    type: boolean
    default: true
    description: Enable the process agent.
  - name: agent_listen_port
    type: string
    label: Agent Listen Port
    default: '17123'
    description: Change port the Agent is listening to
  - name: generate_processes
    default: true
    type: boolean
    label: Configure Process Integration
    description: Automatically generate process monitoring integration, process.yaml
  - name: generate_monit_processes
    default: true
    type: boolean
    label: Monitor Monit Processes
    description: Add monit processes to process check
  - name: generate_system_processes
    default: true
    type: boolean
    label: Monitor System Processes
    description: Add basic system processes to process check
  - name: generate_ntp_config
    default: true
    type: boolean
    label: Automatically Generate NTP Check
    description: Generate NTP monitoring ntp.yaml
  - name: generate_ntp_config_host
    label: NTP Check Host
    type: string
    default: "0.ubuntu.pool.ntp.org"
    description: NTP host
  - name: generate_disk_config
    label: Generate Disk Check Config
    default: true
    type: boolean
    description: Generate disk configuration, disk.yaml
  - name: generate_disk_config_tag_by_filesystem
    label: Tag By Filesystem
    default: true
    type: boolean
    description: Add tags to mountpoints by filesystem type
  - name: generate_disk_config_all_partitions
    label: Monitor All Partitions
    default: true
    type: boolean
    description: Include all partitions in the system
  - name: enable_gohai
    label: Enable Gohai
    default: true
    type: boolean
    description: Enable gohai metadata collection (default is yes)
  - name: check_runners
    type: string
    default: '1'
    label: Check Runners
    description: "The Agent runs workers in parallel to execute checks. By default the number of workers is set to 1. If set to 0 the agent will automatically determine the best number of runners needed based on the number of checks running. This would optimize the check collection time but may produce CPU spikes."
  - name: forwarder_num_workers
    type: string
    default: '1'
    label: Forwarder Workers
    description: "The number of workers used by the forwarder. Please note each worker will open an outbound HTTP connection towards Datadog's metrics intake at every flush."
  - name: ip_tag
    label: IP Address Tag
    type: boolean
    default: true
    description: Include a tag with the IP address of the VM
  - name: address_tag
    label: Address Tag
    type: boolean
    default: true
    description: Include a tag with the address of the VM
  - name: trace_agent
    label: Enable Trace Agent
    type: boolean
    default: true
    description: Enable the Trace Agent on all virtual machines
  - name: logs_enabled
    label: Enable Logs Agent
    type: boolean
    default: false
    description: Enable the Logs Agent on all virtual machines
  - name: strip_proc_arguments
    label: Strip process arguments
    type: boolean
    default: false
    description: This setting will strip the process arguments from the processes sent by the process agent.

- name: cf-config
  label: Cloud Foundry Settings
  description: Cloud Foundry connection details
  markdown: |
    A [UAA Client and Secret](https://docs.pivotal.io/pivotalcf/uaa/uaa-user-management.html) is required to use the datadog firehose nozzle
    Failing to specify the API user on versions without `datadog-firehose` will result in:

    ```
    unknown property "datadog_firehose_credentials"...
    ```

    See the docs for detailed instructions on creating a user.
  properties:
  - name: insecure_ssl_skip_verify
    type: boolean
    label: Skip SSL validation
    default: false
    description: Skip SSL validation (to allow things like self-signed certs). Do not set to true in production.
  - name: disable_access_control
    type: boolean
    label: Disable Access Control
    default: false
    description: Disable Access Control
  - name: uaa_client
    type: string
    label: UAA Client
    description: UAA client (a user having both "cloud_controller.admin_read_only" and "doppler.firehose")
    optional: false
  - name: uaa_secret
    type: secret
    label: UAA Secret
    description: Secret for the UAA Client
    optional: false
  - name: firehose_subscription_id
    type: string
    label: Firehose subscription id
    default: datadog-firehose-subscription-id
    description: Subscription id unique to nozzle; firehose balances across socket connections having same id.

packages:
- name: datadog-firehose-nozzle-release
  type: bosh-release
  path: resources/datadog-firehose-nozzle-release.tgz
  jobs:
    - name: datadog-firehose-nozzle
      templates:
      - name: datadog-firehose-nozzle
        release: datadog-firehose-nozzle
      dynamic_ip: 1
      instances: 1
      properties:
        datadog:
          api_key: (( .properties.api_key.value ))
          api_url: (( .properties.api_url.value ))/api/v1/series
          additional_api_key_1: (( .properties.additional_api_key_1.value ))
          additional_api_url_1: (( .properties.additional_api_url_1.value ))
          additional_api_key_2: (( .properties.additional_api_key_2.value ))
          additional_api_url_2: (( .properties.additional_api_url_2.value ))
          additional_api_key_3: (( .properties.additional_api_key_3.value ))
          additional_api_url_3: (( .properties.additional_api_url_3.value ))
          additional_api_key_4: (( .properties.additional_api_key_4.value ))
          additional_api_url_4: (( .properties.additional_api_url_4.value ))
          additional_api_key_5: (( .properties.additional_api_key_5.value ))
          additional_api_url_5: (( .properties.additional_api_url_5.value ))
          metric_prefix: (( .properties.metric_prefix.value ))
          custom_tags: (( .properties.tags.value ))
          flush_max_bytes: (( .properties.flush_max_bytes.value ))
          flush_duration_seconds: (( .properties.flush_duration_seconds.value ))
        nozzle:
          insecure_ssl_skip_verify: (( .properties.insecure_ssl_skip_verify.value ))
          disable_access_control: (( .properties.disable_access_control.value ))
          subscription_id: (( .properties.firehose_subscription_id.value ))
          deployment: (( name ))
          app_metrics: (( .properties.app_metrics.value ))
          num_workers: (( .properties.num_workers.value ))
          grab_interval: (( .properties.grab_interval.value ))
          http_proxy_url: (( .properties.http_proxy_url.value ))
          https_proxy_url: (( .properties.https_proxy_url.value ))
          no_proxy: (( .properties.no_proxy.value ))
        uaa:
          client: (( .properties.uaa_client.value ))
          client_secret: (( .properties.uaa_secret.value ))
          url: https://uaa.(( ..cf.cloud_controller.system_domain.value ))
        cc:
          endpoint: https://api.(( ..cf.cloud_controller.system_domain.value ))

- name: datadog-agent-boshrelease
  type: bosh-release
  path: resources/datadog-agent-release.tgz


runtime_configs:
  - name: datadog-agent
    runtime_config:
      releases:
        - name: datadog-agent
          version: 2.7.6100 # Update this if update the agent
      addons:
      - name: datadog
        include:
          stemcell:
          - os: ubuntu-xenial
          - os: ubuntu-trusty
          - os: centos-7
        jobs:
        - name: dd-agent
          release: datadog-agent
        properties:
          dd:
            skip_ssl_validation: (( .properties.skip_ssl_validation.value ))
            use_dogstatsd: yes
            dogstatsd_port: 18125 # Many Cloud Foundry deployments have their own StatsD listening on port 8125
            process_agent_enabled: yes
            api_key: (( .properties.api_key.value ))
            additional_api_key_1: (( .properties.additional_api_key_1.value ))
            additional_api_url_1: (( .properties.additional_api_url_1.value ))
            additional_api_key_2: (( .properties.additional_api_key_2.value ))
            additional_api_url_2: (( .properties.additional_api_url_2.value ))
            additional_api_key_3: (( .properties.additional_api_key_3.value ))
            additional_api_url_3: (( .properties.additional_api_url_3.value ))
            additional_api_key_4: (( .properties.additional_api_key_4.value ))
            additional_api_url_4: (( .properties.additional_api_url_4.value ))
            additional_api_key_5: (( .properties.additional_api_key_5.value ))
            additional_api_url_5: (( .properties.additional_api_url_5.value ))
            friendly_hostname: (( .properties.use_friendly_hostname.value ))
            tags: (( .properties.tags.value ))
            proxy:
              http: (( .properties.http_proxy_url.value ))
              https: (( .properties.https_proxy_url.value ))
              no_proxy: (( .properties.no_proxy.value ))
            url: (( .properties.api_url.value ))
            use_uuid_hostname: (( .properties.use_uuid_hostname.value ))
            process_agent_enabled: (( .properties.process_agent_enabled.value ))
            agent_listen_port: (( .properties.agent_listen_port.value ))
            generate_processes: (( .properties.generate_processes.value ))
            generate_monit_processes: (( .properties.generate_monit_processes.value ))
            generate_system_processes: (( .properties.generate_system_processes.value ))
            generate_ntp_config: (( .properties.generate_ntp_config.value ))
            generate_ntp_config_host: (( .properties.generate_ntp_config_host.value ))
            generate_disk_config: (( .properties.generate_disk_config.value ))
            generate_disk_config_tag_by_filesystem: (( .properties.generate_disk_config_tag_by_filesystem.value ))
            generate_disk_config_all_partitions: (( .properties.generate_disk_config_all_partitions.value ))
            enable_gohai: (( .properties.enable_gohai.value ))
            check_runners: (( .properties.check_runners.value ))
            forwarder_num_workers: (( .properties.forwarder_num_workers.value ))
            ip_tag: (( .properties.ip_tag.value ))
            address_tag: (( .properties.address_tag.value ))
            trace_agent_enabled: (( .properties.trace_agent.value ))
            logs_enabled: (( .properties.logs_enabled.value ))
            strip_proc_arguments: (( .properties.strip_proc_arguments.value ))
